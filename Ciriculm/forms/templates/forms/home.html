{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CV Submission</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f7f9fb; font-family: 'Inter', sans-serif; }
    .card { border-radius: .75rem; }
    .section-header { font-weight:600; }
    .field-box { border:1px solid #e6e9ee; padding:12px; border-radius:6px; background:#fff; }
    .small-muted { color:#6c757d; font-size:.9rem; }
    .clickable { cursor: pointer; }
    .avatar-preview { width:96px; height:96px; object-fit:cover; border-radius:8px; border:1px solid #e6e9ee; }
    .add-btn { color:#0d6efd; cursor:pointer; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-9">
      <div class="card shadow-sm p-4">

        <h3 class="mb-3">CV Submission</h3>

        <!-- PERSONAL DETAILS -->
        <div class="mb-4">
          <div class="section-header mb-2">Personal details</div>
          <div class="row g-3">
            <div class="col-md-2 text-center">
              <img id="avatarPreview" src="{% static 'orders/img/avatar-placeholder.png' %}" alt="avatar" class="avatar-preview mb-2">
              <input id="photoFile" type="file" accept="image/*" class="form-control form-control-sm" />
              <div class="small-muted mt-1">Profile photo (optional)</div>
            </div>

            <div class="col-md-10">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Given name</label>
                  <input id="given_name" class="form-control" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Family name</label>
                  <input id="family_name" class="form-control" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Phone number</label>
                  <input id="phone" class="form-control" placeholder="07xx xxx xxx" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Email address</label>
                  <input id="email" class="form-control" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address</label>
                  <input id="address" class="form-control" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Postal code</label>
                  <input id="postal_code" class="form-control" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CAREER GOALS -->
        <div class="mb-4">
          <div class="section-header mb-2 clickable" data-bs-toggle="collapse" data-bs-target="#careerGoals">Career goals</div>
          <div id="careerGoals" class="collapse show">
            <textarea id="career_goals" class="form-control" rows="2" placeholder="What type of job are you targeting?"></textarea>
          </div>
        </div>

        <!-- WORK EXPERIENCE -->
        <div class="mb-4">
          <div class="section-header mb-2">Work experience <small class="small-muted">(<span id="weCount">1</span>)</small></div>
          <div id="workExpList"></div>
          <div class="mt-2"><a class="add-btn" id="addWork">+ Add another work experience</a></div>
        </div>

        <!-- EDUCATION -->
        <div class="mb-4">
          <div class="section-header mb-2">Education <small class="small-muted">(<span id="edCount">1</span>)</small></div>
          <div id="eduList"></div>
          <div class="mt-2"><a class="add-btn" id="addEdu">+ Add another education</a></div>
        </div>

        <!-- ADDITIONAL INFO -->
        <div class="mb-4">
          <div class="section-header mb-2 clickable" data-bs-toggle="collapse" data-bs-target="#additionalInfo">Additional information</div>
          <div id="additionalInfo" class="collapse show">
            <textarea id="instructions" class="form-control" rows="3" placeholder="Special instructions, cover letter, etc."></textarea>
          </div>
        </div>

        <!-- ACTIONS -->
        <div class="d-flex gap-2">
          <button id="saveLocal" class="btn btn-outline-secondary">Save locally</button>
          <button id="clearLocal" class="btn btn-outline-danger">Clear saved progress</button>
          <div class="ms-auto">
            <button id="previewBtn" class="btn btn-primary">Preview</button>
            <button id="submitBtn" class="btn btn-success">Submit</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Form Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="previewBody" style="white-space:pre-wrap;"></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let weCount = 0, edCount = 0;

// Add Work Experience Block
function createWorkBlock(data={}) {
  weCount++;
  document.getElementById('weCount').textContent = weCount;
  const div = document.createElement('div');
  div.className = "mb-2 border p-2 rounded";
  div.innerHTML = `
    <input class="form-control mb-1" placeholder="Position" value="${data.position || ''}">
    <input class="form-control mb-1" placeholder="Company" value="${data.company || ''}">
    <input class="form-control mb-1" placeholder="Start date" value="${data.start_date || ''}">
    <input class="form-control mb-1" placeholder="End date" value="${data.end_date || ''}">
    <textarea class="form-control mb-1" placeholder="Description">${data.description || ''}</textarea>
    <button type="button" class="btn btn-danger btn-sm remove-btn">Remove</button>`;
  div.querySelector('.remove-btn').onclick = ()=>{ div.remove(); weCount--; document.getElementById('weCount').textContent = weCount; };
  document.getElementById('workExpList').appendChild(div);
}

// Add Education Block
function createEduBlock(data={}) {
  edCount++;
  document.getElementById('edCount').textContent = edCount;
  const div = document.createElement('div');
  div.className = "mb-2 border p-2 rounded";
  div.innerHTML = `
    <input class="form-control mb-1" placeholder="Degree" value="${data.degree || ''}">
    <input class="form-control mb-1" placeholder="Institution" value="${data.institution || ''}">
    <input class="form-control mb-1" placeholder="Start date" value="${data.start_date || ''}">
    <input class="form-control mb-1" placeholder="End date" value="${data.end_date || ''}">
    <textarea class="form-control mb-1" placeholder="Description">${data.description || ''}</textarea>
    <button type="button" class="btn btn-danger btn-sm remove-btn">Remove</button>`;
  div.querySelector('.remove-btn').onclick = ()=>{ div.remove(); edCount--; document.getElementById('edCount').textContent = edCount; };
  document.getElementById('eduList').appendChild(div);
}

// Load saved blocks
document.getElementById('addWork').onclick = ()=>createWorkBlock();
document.getElementById('addEdu').onclick = ()=>createEduBlock();

// Preview Modal
document.getElementById('previewBtn').onclick = ()=>{
  let preview = '';
  preview += `Name: ${document.getElementById('given_name').value} ${document.getElementById('family_name').value}\n`;
  preview += `Phone: ${document.getElementById('phone').value}, Email: ${document.getElementById('email').value}\n`;
  preview += `Address: ${document.getElementById('address').value}, Postal: ${document.getElementById('postal_code').value}\n`;
  preview += `Career goals:\n${document.getElementById('career_goals').value}\n`;
  preview += `Work Experience:\n`;
  document.querySelectorAll('#workExpList > div').forEach(d=>{
    preview += Array.from(d.querySelectorAll('input,textarea')).map(f=>f.value).join(', ')+'\n';
  });
  preview += `Education:\n`;
  document.querySelectorAll('#eduList > div').forEach(d=>{
    preview += Array.from(d.querySelectorAll('input,textarea')).map(f=>f.value).join(', ')+'\n';
  });
  preview += `Additional Info:\n${document.getElementById('instructions').value}`;
  document.getElementById('previewBody').textContent = preview;
  new bootstrap.Modal(document.getElementById('previewModal')).show();
};

// LocalStorage
document.getElementById('saveLocal').onclick = ()=>{
  const data = {given_name:document.getElementById('given_name').value,family_name:document.getElementById('family_name').value,
  phone:document.getElementById('phone').value,email:document.getElementById('email').value,address:document.getElementById('address').value,
  postal_code:document.getElementById('postal_code').value,career_goals:document.getElementById('career_goals').value,
  work:Array.from(document.querySelectorAll('#workExpList > div')).map(d=>Array.from(d.querySelectorAll('input,textarea')).reduce((o,f)=>{o[f.placeholder.toLowerCase().split(' ')[0]]=f.value;return o;},{ })),
  edu:Array.from(document.querySelectorAll('#eduList > div')).map(d=>Array.from(d.querySelectorAll('input,textarea')).reduce((o,f)=>{o[f.placeholder.toLowerCase().split(' ')[0]]=f.value;return o;},{})),
  instructions:document.getElementById('instructions').value
  };
  localStorage.setItem('cv_form', JSON.stringify(data));
  alert('Saved locally!');
};

document.getElementById('clearLocal').onclick = ()=>{
  localStorage.removeItem('cv_form'); alert('Local storage cleared!');
};

// Load from localStorage
window.onload = ()=>{
  const saved = JSON.parse(localStorage.getItem('cv_form') || '{}');
  if(Object.keys(saved).length){
    document.getElementById('given_name').value = saved.given_name||'';
    document.getElementById('family_name').value = saved.family_name||'';
    document.getElementById('phone').value = saved.phone||'';
    document.getElementById('email').value = saved.email||'';
    document.getElementById('address').value = saved.address||'';
    document.getElementById('postal_code').value = saved.postal_code||'';
    document.getElementById('career_goals').value = saved.career_goals||'';
    document.getElementById('instructions').value = saved.instructions||'';
    if(saved.work) saved.work.forEach(d=>createWorkBlock(d));
    if(saved.edu) saved.edu.forEach(d=>createEduBlock(d));
  } else { createWorkBlock(); createEduBlock(); }
};

// Avatar preview
document.getElementById('photoFile').onchange = e=>{
  if(e.target.files && e.target.files[0]){
    document.getElementById('avatarPreview').src = URL.createObjectURL(e.target.files[0]);
  }
};

// Submit AJAX
document.getElementById('submitBtn').onclick = ()=>{
  const data = {given_name:document.getElementById('given_name').value,family_name:document.getElementById('family_name').value,
  phone:document.getElementById('phone').value,email:document.getElementById('email').value,address:document.getElementById('address').value,
  postal_code:document.getElementById('postal_code').value,career_goals:document.getElementById('career_goals').value,
  work:Array.from(document.querySelectorAll('#workExpList > div')).map(d=>Array.from(d.querySelectorAll('input,textarea')).reduce((o,f)=>{o[f.placeholder.toLowerCase().split(' ')[0]]=f.value;return o;},{ })),
  edu:Array.from(document.querySelectorAll('#eduList > div')).map(d=>Array.from(d.querySelectorAll('input,textarea')).reduce((o,f)=>{o[f.placeholder.toLowerCase().split(' ')[0]]=f.value;return o;},{})),
  instructions:document.getElementById('instructions').value
  };
  fetch('{% url "forms:submit_cv" %}',{
    method:'POST',body:JSON.stringify(data),headers:{'Content-Type':'application/json'}
  }).then(r=>r.json()).then(res=>{
    if(res.status=='success'){ window.location.href='/subscription/packages/'; }
    else{ alert(res.message || 'Error submitting form'); }
  }).catch(e=>alert('Error submitting form'));
};
</script>

</body>
</html>
